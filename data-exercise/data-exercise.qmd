---
title: "Data Exercise(Week4)"
---

Prompt Using the tidyverse package, write an R code to generate a synthetic dataset with N=1000. The research subjects are people over 50 years old. The dataset should include ID, age (ranging from 50 to 95, with more concentrated in the range of 55-75), gender, years of education, BMI (with an average of about 27 and a standard deviation of about 5), physical activity level, history of depression (about 15-20%), and the number of comorbidities such as diabetes and hypertension. The occurrence probability of comorbidities should increase with age and BMI. Moreover, depression is also related to dementia. It particularly emphasizes that age and depression are strong risk factors, higher education and higher physical activity have protective effects, diabetes and hypertension increase the risk, and BMI has a non-linear (U-shaped) relationship with the risk.

```{r, echo=FALSE, message=FALSE}
# 0) Load required packages
library(tidyverse)

# 1) Reproducibility seed
base::set.seed(1)

# 2) functions
inv_logit <- function(x) 1 / (1 + base::exp(-x))
clamp <- function(x, lower, upper) base::pmax(lower, base::pmin(x, upper))

# 3) Sample size
N <- 1000

# 4) Generate synthetic dataset
synthetic_data <- tibble::tibble(
  ID = base::sprintf("%05d", 1:N),

  # Age: 85% from truncated normal-like around 65, 15% from uniform tails
  age = {
    mix <- stats::rbinom(n = N, size = 1, prob = 0.85)
    main <- clamp(stats::rnorm(n = N, mean = 65, sd = 7.5), 50, 95)
    tail <- stats::runif(n = N, min = 50, max = 95)
    base::as.integer(base::round(base::ifelse(mix == 1, main, tail)))
  },

  # Gender: ~52% female
  gender = {
    g <- stats::rbinom(n = N, size = 1, prob = 0.52)
    base::factor(base::ifelse(g == 1, "Female", "Male"), levels = c("Male", "Female"))
  }
) |>
  dplyr::mutate(
    # Education (years): mean ~13 with mild cohort effect (older -> slightly fewer years)
    education_years = {
      edu_base <- stats::rnorm(n = N, mean = 13, sd = 2.7)
      edu <- clamp(edu_base - 0.03 * (age - 65), 0, 22)
      base::as.integer(base::round(edu))
    },

    # BMI: mean ~27 sd ~5, mild age pattern, clamped
    BMI = {
      bmi_base <- stats::rnorm(n = N, mean = 27, sd = 5)
      bmi_val <- clamp(bmi_base + 0.03 * (pmin(age, 70) - 50), 15, 55)
      base::round(bmi_val, 1)
    },

    # Physical activity: ordered factor influenced by education (+) and age (-)
    physical_activity = {
      latent <- 0.12 * (education_years - 12) - 0.03 * (age - 65) + stats::rnorm(n = N)
      pa <- base::cut(
        latent,
        breaks = c(-Inf, -0.4, 0.8, Inf),
        labels = c("Low", "Moderate", "High"),
        right = TRUE
      )
      base::factor(pa, levels = c("Low", "Moderate", "High"), ordered = TRUE)
    },

    # Depression history: ~15â€“20% with links to age and physical activity
    depression_history = {
      lp <- -1.6 +
        0.012 * (age - 65) +
        0.25  * (physical_activity == "Low") -
        0.10  * (physical_activity == "High") +
        0.08  * (gender == "Female")
      stats::rbinom(n = N, size = 1, prob = inv_logit(lp))
    },

    # Diabetes and hypertension: probabilities increase with age and BMI
    diabetes = {
      lp <- -2.0 + 0.035 * (age - 65) + 0.070 * (BMI - 27) + 0.15 * (gender == "Male")
      stats::rbinom(n = N, size = 1, prob = inv_logit(lp))
    },

    hypertension = {
      lp <- -1.0 + 0.050 * (age - 65) + 0.040 * (BMI - 27) + 0.10 * (gender == "Male")
      stats::rbinom(n = N, size = 1, prob = inv_logit(lp))
    },

    # Number of comorbidities (0,1,2) among diabetes + hypertension
    n_comorbidities = diabetes + hypertension,

    # Dementia (0/1): age & depression strong risk; edu & PA protective;
    # diabetes & hypertension risk; BMI U-shaped via quadratic term
    dementia = {
      bmi_u <- ((BMI - 27)^2) / 25
      lp <- -3.2 +
        0.075 * (age - 65) +
        0.85  * depression_history +
        (-0.08) * (education_years - 13) +
        (-0.25) * (physical_activity == "Moderate") +
        (-0.50) * (physical_activity == "High") +
        0.45  * diabetes +
        0.35  * hypertension +
        0.55  * bmi_u
      stats::rbinom(n = N, size = 1, prob = inv_logit(lp))
    },

    # Optional BMI category (interpretability)
    BMI_category = base::cut(
      BMI,
      breaks = c(-Inf, 18.5, 25, 30, Inf),
      labels = c("Under/Low", "Normal", "Overweight", "Obese"),
      right = FALSE
    )
  )

```

